<!DOCTYPE html>
<html lang="en">
<head>
    <title>PokeColor</title>
    <style>
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        
        form {
            text-align: center;
            width: 100%;
            height: 10%;
            margin-bottom: 20px;
        }
        
        #pokemon, #palette {
            width:150,
            height:150,
            margin: 0 auto;
            text-align: center;
            
        }
        
    
    </style>

    <script>
        // Example Links to search for
        // Eventful API - NEEDS KEY http://api.eventful.com/
        //    http://api.eventful.com/json/events/search?location=14623&app_key=YOURKEY
        // USGS Earthquake data - http://earthquake.usgs.gov/earthquakes/feed/v1.0/geojson.php
        //    http://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_hour.geojson
        // Pokemon API - https://pokeapi.co/
        //    http://pokeapi.co/api/v2/pokemon/1/
        // Star Wars API - https://swapi.co/ 
        //    http://swapi.co/api/people/1/
        
        window.onload = init;
        var loading = "<img src='images/loading.gif'>"
        
        function init() {
            document.querySelector("#proxyForm").addEventListener("submit", sendAjax);
            document.querySelector("#randomButton").onclick = randomPoke;
        }
        
        //method for searching specific pokemon, based on in class example
        function sendAjax(e) {
            var responseDiv = document.querySelector("#pokemon");
            responseDiv.innerHTML = loading;
            var action = document.querySelector("#proxyForm").getAttribute("action");
            var query = document.querySelector("#url").value;
            
            if(!query || query.length === 0) {
                e.preventDefault();
                return false;
            }
            
            //turn query into a proper pokeapi url
            query = "http://pokeapi.co/api/v2/pokemon/" + query;
            
            query = encodeURIComponent(query);
            
            var url = action + "?url=" + query;
            
            //console.dir(url);
            
            var xhr = new XMLHttpRequest();
            
            xhr.onload = function() {
                
                
                //parse the response?
                var pokemon = JSON.parse(xhr.responseText);
                if (pokemon.sprites.front_default){
                    responseDiv.innerHTML = "<img src=" + pokemon.sprites.front_default + ">";
                    getPalette();
                }
                else if (pokemon.message){
                    responseDiv.textContent = pokemon.message;
                }
                
                //responseDiv.textContent = xhr.responseText;
            };
            
            xhr.open('GET', url);
            
            xhr.send();
            
            e.preventDefault();
            return false;
        }
        
    //method for getting a random poke; just modified version of sendAjax
        function randomPoke(e){
            var responseDiv = document.querySelector("#pokemon");
            responseDiv.innerHTML = loading;
            var action = document.querySelector("#proxyForm").getAttribute("action");
            var num = Math.round(Math.random() * 181) + 1;
            var query = query = "http://pokeapi.co/api/v2/pokemon/" + num;
            
            query = encodeURIComponent(query);
            
            var url = action + "?url=" + query;
            
            //console.dir(url);
            
            var xhr = new XMLHttpRequest();
            
            xhr.onload = function() {
                
                
                //parse the response?
                var pokemon = JSON.parse(xhr.responseText);
                if (pokemon.sprites.front_default){
                    var imgurl = pokemon.sprites.front_default;
                    responseDiv.innerHTML = "<img id='pokepic' src=" + imgurl + ">";
                    
                    //get the palette
                    //getPalette(imgurl);
                    getPalette(imgurl);
                }
                else if (pokemon.message){
                    responseDiv.textContent = pokemon.message;
                }
                
                //responseDiv.textContent = xhr.responseText;
            };
            
            xhr.open('GET', url);
            
            xhr.send();
            
            e.preventDefault();
            return false;
        }
        
        //request color palette for pokemon picture
        function getPalette(img){
            
            //show that palette is loading
            var responseDiv = document.querySelector('#palette');
            responseDiv.innerHTML = loading;
            
            var url = 'http://pictaculous.com/api/1.0/';
            url = encodeURIComponent(url);
            
            var action = document.querySelector("#proxyForm").getAttribute("action");
            url = action + "?url=" + url;
            
            //grab the image from the pokemon div
            img = document.querySelector("#pokepic").src;
            //console.dir(img);
            //img = encodeURIComponent(img);
            //console.dir(img);
            
            var xhr = new XMLHttpRequest();
            
            xhr.onload = function(){
                //handle response and display palette
                
                console.dir((xhr.responseText));
            }
            
            xhr.open('POST', url, true);
            //xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
            xhr.send(img);
            
        }
        
    </script>
</head>
<body>
  <form id="proxyForm" action="http://127.0.0.1:3000" method="POST">
      <label for="url">Search Pokemon by Name or Number: </label>
      <input type="text" name="url" id="url">
      <input type="submit" value="Submit">
      <button id="randomButton">Or Get a Random Pokemon</button>
  </form>

    <div id="pokemon">
    
    </div>
    <div id="palette">
        
    </div>

</body>
</html>